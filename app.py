from telebot.types import InlineKeyboardButton, InlineKeyboardMarkup
from telebot import types
import telebot

import config
from modules.scripts import *
from modules.commands import *


bot = telebot.TeleBot(config.API)  # —Å–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞

# –ö–õ–ê–í–ò–ê–¢–£–†–´
btn_happy = types.InlineKeyboardButton("üòä", callback_data='mood:–°—á–∞—Å—Ç—å–µ')
btn_sad = types.InlineKeyboardButton("üò¢", callback_data='mood:–ì—Ä—É—Å—Ç—å')
btn_profile = InlineKeyboardButton(text="–ü—Ä–æ—Ñ–∏–ª—å", callback_data="profile")
keyboard_main = InlineKeyboardMarkup(row_width=2)
keyboard_main.add(btn_happy, btn_sad)
keyboard_main.add(btn_profile)

btn_return_main = InlineKeyboardButton(text="< –ù–∞–∑–∞–¥", callback_data='return:main')
btn_skip = InlineKeyboardButton(text="–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å >", callback_data='skip')
keyboard_mood_settings = InlineKeyboardMarkup(row_width = 2)
keyboard_mood_settings.add(btn_return_main, btn_skip)

keyboard_profile = InlineKeyboardMarkup(row_width=2)
keyboard_profile.add(btn_return_main)

def send_message(message, mood, message_id):
    add_mood(message.chat.id, mood, message.text)
    bot.delete_message(message.chat.id, message.message_id)
    bot.edit_message_text(chat_id=message.chat.id, message_id=message_id, text="–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", reply_markup=keyboard_main)



commands = [  # –ö–û–ú–ê–ù–î–´
telebot.types.BotCommand("start", "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫"),
]


# –ö–û–ú–ê–ù–î–´
@bot.message_handler(commands=['start'])  # –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã start
def start(message):
    menu_id = registration(message)
    bot.send_message(message.chat.id, text="–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", reply_markup=keyboard_main)
    bot.delete_message(message.chat.id, message.id)
    if menu_id:
        bot.delete_message(message.chat.id, menu_id)



# –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ó–û–í–û–í
@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):  # —Ä–∞–±–æ—Ç–∞ —Å –≤—ã–∑–æ–≤–∞–º–∏ inline –∫–Ω–æ–ø–æ–∫
    user_id = call.message.chat.id
    message_id = call.message.message_id
    user = SQL_request("SELECT * FROM users WHERE id = ?", (int(user_id),))
    print(call.data)

    if call.data == 'profile':
        # text = profile(user)
        # bot.answer_callback_query(callback_query_id=call.id, show_alert=True, text=text)
        date, time = now_time()
        text = get_only_mood(user_id, date)
        text = text.replace("–°—á–∞—Å—Ç—å–µ", "üòä")
        text = text.replace("–ì—Ä—É—Å—Ç—å", "üò¢")
        text = format_emojis(text)
        bot.edit_message_text(chat_id=user_id, message_id=message_id, text=text, reply_markup=keyboard_profile)

    if (call.data).split(":")[0] == 'mood':
        mood = (call.data).split(":")[1]
        text = f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {mood}\n\n–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Ç–∞–∫–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è"
        bot.edit_message_text(chat_id=user_id, message_id=message_id, text=text, reply_markup=keyboard_mood_settings)
        bot.register_next_step_handler(call.message, send_message, mood, message_id)

    if call.data == 'skip':
        mood = (call.message.text).split(": ")[1].split("\n")[0]
        add_mood(user_id, mood, "")
        bot.edit_message_text(chat_id=user_id, message_id=message_id, text="–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", reply_markup=keyboard_main)


    if (call.data).split(":")[0] == 'return':
        bot.clear_step_handler_by_chat_id(chat_id=user_id)
        if (call.data).split(":")[1] == 'main':
             bot.edit_message_text(chat_id=user_id, message_id=message_id, text="–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", reply_markup=keyboard_main)



print(f"–±–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
bot.polling(none_stop=True)